<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель Управления Записями</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body { font-family: sans-serif; }
    </style>
    <script>
        // --- ВАЖНО: ЗАМЕНИТЕ ЭТОТ URL НА СВОЙ API_ENDPOINT_URL ИЗ GOOGLE APPS SCRIPT ---
        const API_ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbxmGWhE6Hnqw5Js_9CFKzvNCLPJ0tMulqaPtqom9RsQe9p9J5cquGgKtH1Iy1UiQ-b-/exec'
        // НЕ ЗАБУДЬТЕ ПОСТАВИТЬ /exec В КОНЦЕ!

        let currentUser = null; // Текущий залогиненный пользователь

       // --- Вспомогательная функция для отправки запросов на Apps Script ---
async function sendApiRequest(route, method = 'GET', body = null, id = null) {
    const url = new URL(API_ENDPOINT_URL);
    url.searchParams.append('route', route); // <-- ЭТА СТРОКА ВАЖНА!
    url.searchParams.append('method', method); // Передаем метод как параметр для POST/PUT/DELETE
    if (id !== null) {
        url.searchParams.append('id', id);
    }

    const headers = {
        'Content-Type': 'application/json'
    };
    if (currentUser && currentUser.login) {
        // Передаем логин как "токен" для авторизации
        headers['Authorization'] = `Bearer ${currentUser.login}`;
    }

    const requestOptions = {
        method: method === 'GET' ? 'GET' : 'POST', // Все POST/PUT/DELETE отправляем как POST для Apps Script
        headers: headers
    };
    if (body) {
        requestOptions.body = JSON.stringify(body);
    }

    const response = await fetch(url.toString(), requestOptions);
    const data = await response.json(); 

    if (data.status) {
        return { ok: data.status >= 200 && data.status < 300, json: data };
    }
    return { ok: response.ok, json: data };
}

        // --- Функции аутентификации и выхода ---
        async function login() {
            const loginInput = document.getElementById('login').value;
            const passwordInput = document.getElementById('password').value;
            const messageDiv = document.getElementById('loginMessage');
            const userInfoDiv = document.getElementById('userInfo');

            try {
                const { ok, json: data } = await sendApiRequest('login', 'POST', { login: loginInput, password: passwordInput });

                if (ok) {
                    currentUser = data.user;
                    messageDiv.textContent = `Добро пожаловать, ${currentUser.login}! Роль: ${currentUser.role}`;
                    messageDiv.className = 'text-green-500 mb-4';
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    
                    userInfoDiv.textContent = `Добро пожаловать, ${currentUser.login} (${currentUser.role})`;
                    userInfoDiv.classList.remove('hidden');

                    displayRecords();
                } else {
                    messageDiv.textContent = data.message || 'Неизвестная ошибка входа.';
                    messageDiv.className = 'text-red-500 mb-4';
                }
            } catch (error) {
                console.error('Ошибка сети или сервера при входе:', error);
                messageDiv.textContent = 'Ошибка подключения к серверу.';
                messageDiv.className = 'text-red-500 mb-4';
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('login').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginMessage').textContent = '';
            document.getElementById('recordsTableBody').innerHTML = '';
            
            const userInfoDiv = document.getElementById('userInfo');
            userInfoDiv.textContent = '';
            userInfoDiv.classList.add('hidden');
        }

        // --- Функции отображения записей ---
        async function displayRecords() {
            const recordsTableBody = document.getElementById('recordsTableBody');
            recordsTableBody.innerHTML = '';

            try {
                const { ok, json: records } = await sendApiRequest('records', 'GET');

                if (ok) {
                    records.forEach(record => {
                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        row.innerHTML = `
                            <td class="py-2 px-4">${record.id}</td>
                            <td class="py-2 px-4">${record.title}</td>
                            <td class="py-2 px-4">${record.content}</td>
                            <td class="py-2 px-4">
                                <button onclick="editRecord(${record.id})" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 mr-2">Редактировать</button>
                                <button onclick="deleteRecord(${record.id})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Удалить</button>
                            </td>
                        `;
                        recordsTableBody.appendChild(row);
                    });
                } else {
                    alert(records.message || 'Ошибка при получении записей.');
                    console.error('Ошибка получения записей:', records);
                }
            } catch (error) {
                console.error('Ошибка сети или сервера при получении записей:', error);
                alert('Не удалось загрузить записи. Ошибка сервера.');
            }
        }

        // --- Функции управления записями ---
        async function editRecord(recordId) {
            if (!currentUser) {
                alert('Вы не вошли в систему.');
                return;
            }

            let currentRecordTitle = '';
            let currentRecordContent = '';
            try {
                const { ok, json: record } = await sendApiRequest('records', 'GET', null, recordId);
                if (ok) {
                    currentRecordTitle = record.title;
                    currentRecordContent = record.content;
                } else {
                    alert(record.message || 'Не удалось получить данные записи для редактирования.');
                    return;
                }
            } catch (error) {
                console.error('Ошибка при получении записи для редактирования:', error);
                alert('Ошибка сервера при получении записи.');
                return;
            }

            const newTitle = prompt('Введите новый заголовок:', currentRecordTitle);
            const newContent = prompt('Введите новое содержание:', currentRecordContent);

            if (newTitle !== null && newContent !== null) {
                try {
                    const { ok, json: data } = await sendApiRequest('records', 'PUT', { title: newTitle, content: newContent }, recordId);

                    if (ok) {
                        alert('Запись обновлена!');
                        displayRecords();
                    } else {
                        alert(data.message || 'Ошибка обновления записи.');
                        console.error('Ошибка обновления:', data);
                    }
                } catch (error) {
                    console.error('Ошибка сети или сервера при обновлении записи:', error);
                    alert('Ошибка подключения к серверу при обновлении.');
                }
            }
        }

        async function deleteRecord(recordId) {
            if (!currentUser) {
                alert('Вы не вошли в систему.');
                return;
            }

            if (confirm('Вы уверены, что хотите удалить эту запись?')) {
                try {
                    const { ok, json: data } = await sendApiRequest('records', 'DELETE', null, recordId);

                    if (ok) {
                        alert('Запись удалена!');
                        displayRecords();
                    } else {
                        alert(data.message || 'Ошибка удаления записи.');
                        console.error('Ошибка удаления:', data);
                    }
                } catch (error) {
                    console.error('Ошибка сети или сервера при удалении записи:', error);
                    alert('Ошибка подключения к серверу при удалении.');
                }
            }
        }

        // Функция для сброса всех данных (полезно для отладки)
        async function resetAllData() {
            if (confirm('Внимание! Это удалит все сохраненные записи и сбросит их к начальным. Продолжить?')) {
                try {
                    const { ok, json: data } = await sendApiRequest('reset-data', 'POST');

                    if (ok) {
                        alert(data.message);
                        if (currentUser) { // Если пользователь залогинен, обновим отображение
                            displayRecords();
                        }
                    } else {
                        alert(data.message || 'Ошибка при сбросе данных.');
                    }
                } catch (error) {
                    console.error('Ошибка сети или сервера при сбросе данных:', error);
                    alert('Ошибка подключения к серверу при сбросе данных.');
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

    <div id="loginForm" class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
        <h2 class="text-2xl font-bold text-center mb-6">Вход</h2>
        <div id="loginMessage" class="mb-4 text-center"></div>
        <div class="mb-4">
            <label for="login" class="block text-gray-700 text-sm font-bold mb-2">Логин:</label>
            <input type="text" id="login" name="login" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        </div>
        <div class="mb-6">
            <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Пароль:</label>
            <input type="password" id="password" name="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline">
        </div>
        <button onclick="login()" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full focus:outline-none focus:shadow-outline">
            Войти
        </button>
    </div>

    <div id="adminPanel" class="hidden bg-white p-8 rounded-lg shadow-md w-full max-w-4xl mt-8 relative">
        <div id="userInfo" class="absolute top-4 right-4 text-gray-600 font-semibold hidden"></div>

        <h2 class="text-2xl font-bold text-center mb-6">Панель Управления Записями</h2>
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Список Записей</h3>
            <div class="flex items-center space-x-2">
                <button onclick="resetAllData()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Сбросить данные
                </button>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Выйти
                </button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200">
                <thead>
                    <tr class="bg-gray-100 border-b">
                        <th class="py-2 px-4 text-left">ID</th>
                        <th class="py-2 px-4 text-left">Заголовок</th>
                        <th class="py-2 px-4 text-left">Содержание</th>
                        <th class="py-2 px-4 text-left">Действия</th>
                    </tr>
                </thead>
                <tbody id="recordsTableBody">
                    </tbody>
            </table>
        </div>
    </div>

</body>
</html>
